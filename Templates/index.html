<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>HTML CodeSniffer + Image Analyzer with Machine Learning</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css"
          integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.css"/>
    <style>
        .dropzone {
            border: none;
            background: transparent;
        }
    </style>
</head>

<body>

<header>
    <div class="navbar navbar-dark bg-dark box-shadow">
        <div class="container d-flex justify-content-between">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>HTML CodeSniffer + Image Analyzer with Machine Learning</strong>
            </a>
        </div>
    </div>
</header>

<main role="main">

    <div class="row">
        <div class="col-sm-12">
            <div class="jumbotron mb-0 pt-1 pb-0 text-center">
                <div class="container">
                    <form action="/analyze" id="file-drop" class="dropzone" method="post">

                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 32 32" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                            <circle cx="17" cy="15" r="1" />
                            <circle cx="16" cy="16" r="6" />
                            <path d="M2 16 C2 16 7 6 16 6 25 6 30 16 30 16 30 16 25 26 16 26 7 26 2 16 2 16 Z" />
                        </svg>
                        <h1 class="jumbotron-heading">Paste or Drop You file here</h1>
                        <p>
                            Validates against <span class="badge badge-dark">WCAG 2.0 - AAA</span>
                        </p>
                        <textarea id="text-file" class="form-control" rows="6"></textarea>
                        <p>
                            <button id="btn-submit" type="button" class="btn btn-primary my-2">Analyze</button>
                        </p>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <div class="py-5 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-4 box-shadow">
                        <div class="card-body">
                            <div id="list-messages" class="list-group">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>


<!-- Bootstrap core JavaScript
================================================== -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
        integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
        integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.js"></script>
<script>
    var MESSAGE_TYPES = ["Error", "Warning", "Notice"];
    var CSS_TYPES = ["danger", "warning", "info"];

    function toggleControls(enable) {
        if (!enable) {
            clearMessages();
        }
        $('textarea, button').attr('disabled', !enable);
    }

    function clearMessages() {
        $('.list-group-item').remove();
    }

    function showError(error) {
        alert(error);
    }

    function addMessages(messages) {
        if (!messages) return;
        var container = $('#list-messages');
        clearMessages();

        messages.sort(function (a, b) {
            return a.type - b.type;
        }).forEach(function (message) {
            console.log(message)
            var html = '<div class="list-group-item list-group-item-action flex-column list-group-item-{{css}}"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">{{code}}</h5><small>{{type}}</small></div><p class="mb-1">{{msg}}</p><small>{{element}}</small></div>';
            html = html.replace("\{\{css\}\}", CSS_TYPES[message.type - 1]);
            html = html.replace("\{\{type\}\}", MESSAGE_TYPES[message.type - 1]);
            html = html.replace("\{\{msg\}\}", message.msg);
            html = html.replace("\{\{element\}\}", "<pre>" + $("<div>").text(message.element).html() + "</pre>");
            html = html.replace("\{\{code\}\}", message.code);

            container.append(html);
            $('.list-group-item').last().html()
        });
    }

    function handleResponse(res) {
        console.log('handleResponse', res);
        if (res.messages) {
            addMessages(res.messages);
        } else if (res.error) {
            showError(res.error);
        }
    }

    Dropzone.autoDiscover = false;
    DZ = new Dropzone("#file-drop", {
        clickable: false,
        acceptedFiles: 'text/html',
        maxFiles: 1,
        sending: function () {
            toggleControls(false);
        },
        success: function (file, res) {
            handleResponse(res);
        },
        complete: function () {
            DZ.removeAllFiles();
            toggleControls(true);
        }
    });
    $('#btn-submit').click(function () {
        toggleControls(false);
        DZ.disable();
        $.post({
            type: "POST",
            url: "/analyze",
            data: JSON.stringify({file: $('#text-file').val()}),
            success: function (res) {
                handleResponse(res);
            },
            complete: function () {
                toggleControls(true);
                DZ.enable();
            },
            contentType: 'application/json',
            dataType: 'json',
        })
    })
</script>
</body>
</html>
